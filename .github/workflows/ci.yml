name: CI

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:

  run-terraform:
    name: 'Run terraform'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-2
        role-to-assume: arn:aws:iam::656003592068:role/tf-role
    
    - name: Create AWS profile 'gabifran' for Terraform ###insert de code 
      run: |
        mkdir -p ~/.aws
        cat > ~/.aws/credentials <<EOF
        [gabifran]
        aws_access_key_id=${AWS_ACCESS_KEY_ID}
        aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}
        aws_session_token=${AWS_SESSION_TOKEN}
        EOF
        # (opcional) tambÃ©m criar ~/.aws/config
        cat > ~/.aws/config <<EOF
        [profile gabifran]
        region=us-east-2
        EOF
        echo "AWS_PROFILE=gabifran" >> $GITHUB_ENV 

    - name: Setup terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.8.4

    - name: Run terraform init
      run: terraform init

    - name: Run terraform format
      run: terraform fmt -check

    - name: Run terraform plan
      run: terraform plan

    - name: Run terraform apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: terraform apply -auto-approve
